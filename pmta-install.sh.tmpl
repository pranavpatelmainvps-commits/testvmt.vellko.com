#!/usr/bin/env bash
set -e

DOMAIN="{{DOMAIN}}"
SERVER_IP="{{SERVER_IP}}"
SMTP_USER="{{SMTP_USER}}"
SMTP_PASS="{{SMTP_PASS}}"

echo "Running PMTA installer for $DOMAIN ($SERVER_IP)"

# ---------------- OS packages ----------------
if command -v apt-get >/dev/null 2>&1; then
  export DEBIAN_FRONTEND=noninteractive
  apt-get update -y
  apt-get install -y curl wget openssl dnsutils netcat ca-certificates
elif command -v yum >/dev/null 2>&1; then
  yum install -y curl wget openssl bind-utils nmap-ncat ca-certificates initscripts
else
  echo "Unsupported OS"
  exit 1
fi

# ---------------- Hostname enforcement ----------------
CURRENT_HOSTNAME="$(hostnamectl --static)"

if [[ "$CURRENT_HOSTNAME" != "$DOMAIN" ]]; then
  echo "Setting hostname to $DOMAIN"
  hostnamectl set-hostname "$DOMAIN"
fi

if ! grep -q "^$SERVER_IP\s\+$DOMAIN" /etc/hosts; then
  echo "Adding /etc/hosts entry"
  echo "$SERVER_IP $DOMAIN" >> /etc/hosts
fi
# ---------------- Preflight checks ----------------
for f in /app/PowerMTA.rpm /app/pmtad /app/pmtahttpd /app/license; do
  if [[ ! -f "$f" ]]; then
    echo "ERROR: Required file missing: $f"
    exit 1
  fi
done

# ---------------- Perl dependency (REQUIRED for PMTA) ----------------
if ! command -v perl >/dev/null 2>&1; then
  echo "Installing Perl dependencies for PowerMTA"
  yum install -y perl
fi

# ---------------- Ensure PowerMTA is installed ----------------
if ! rpm -q PowerMTA >/dev/null 2>&1; then
  echo "PowerMTA not installed, installing from local RPM"

  if [[ ! -f "/app/PowerMTA.rpm" ]]; then
    echo "ERROR: /app/PowerMTA.rpm not found"
    exit 1
  fi

  rpm -Uvh --nosignature --nodigest /app/PowerMTA.rpm
else
  echo "PowerMTA already installed"
fi


# ---------------- PMTA License ----------------
if [[ -f "/app/license" ]]; then
  echo "Installing PMTA license"
  mkdir -p /etc/pmta
  cp /app/license /etc/pmta/license
  chmod 600 /etc/pmta/license
else
  echo "ERROR: PMTA license file missing"
  exit 1
fi

# ---------------- Stop PMTA before binary replacement ----------------
echo "Stopping PMTA service (if running)"
systemctl stop pmta || true

# ---------------- Replace PMTA core binaries ----------------
for BIN in pmtad pmtahttpd; do
  SRC="/app/$BIN"
  DST="/usr/sbin/$BIN"

  if [[ ! -f "$SRC" ]]; then
    echo "ERROR: $SRC not found"
    exit 1
  fi

  echo "Removing existing $DST (if any)"
  rm -f "$DST"

  echo "Copying fresh $BIN to /usr/sbin"
  cp "$SRC" "$DST"

  chown root:root "$DST"
  chmod 755 "$DST"

  # Safety check
  if [[ ! -x "$DST" ]]; then
    echo "ERROR: $DST is not executable after copy"
    exit 1
  fi
done

# ---------------- Main PMTA config ----------------
echo "Preparing PMTA configuration"

# Step 1: Copy default config if main config does not exist
if [[ ! -f /etc/pmta/config ]]; then
    cp /etc/pmta/config-defaults /etc/pmta/config
fi

# Step 2: Append your required working values safely
ensure_line () {
  grep -q "^$1" /etc/pmta/config || echo "$1" >> /etc/pmta/config
}

ensure_line "host-name $DOMAIN"

# Add relay permissions (only if not present)
grep -q "<source 127.0.0.1>" /etc/pmta/config || cat >> /etc/pmta/config <<EOF

<source 127.0.0.1>
    always-allow-relaying yes
</source>

<source ::1>
    always-allow-relaying yes
</source>
EOF

chown pmta:root /etc/pmta/config
chmod 640 /etc/pmta/config

# ---------------- Ensure required directives ----------------
ensure_line () {
  grep -q "^$1" /etc/pmta/config || echo "$1" >> /etc/pmta/config
}

ensure_line "host-name $DOMAIN"

# ---------------- Filesystem ----------------
mkdir -p /var/spool/pmta
chown -R pmta:pmta /var/spool/pmta
chmod 700 /var/spool/pmta

mkdir -p /var/log/pmta
chown -R pmta:pmta /var/log/pmta
chmod 755 /var/log/pmta

# ---------------- Validate config (PMTA 5.x) ----------------
echo "Validating PMTA configuration"
/usr/sbin/pmtad --debug --dontSend &
PMTA_PID=$!
sleep 5

if ! ps -p "$PMTA_PID" >/dev/null 2>&1; then
  echo "ERROR: PMTA validation failed"
  exit 1
fi

echo "PMTA validation successful"
kill "$PMTA_PID"
wait "$PMTA_PID" 2>/dev/null || true


# ---------------- SMTP auth ----------------
echo "$SMTP_USER:$SMTP_PASS" > /etc/pmta/smtp_users.txt
chmod 600 /etc/pmta/smtp_users.txt

# ---------------- Start / Restart PMTA ----------------
echo "Reloading systemd and starting PMTA..."
systemctl daemon-reexec
systemctl daemon-reload

systemctl enable pmta

systemctl restart pmta || {
  echo "PMTA failed to start. Showing last 50 log lines:"
  journalctl -u pmta --no-pager -n 50
  exit 1
}

sleep 2
systemctl status pmta --no-pager

# ---------------- Firewall Configuration ----------------
echo "Configuring Firewall..."
if command -v firewall-cmd >/dev/null 2>&1; then
  if systemctl is-active --quiet firewalld; then
      echo "Opening ports 22, 25, 8080, 2525 in firewalld"
      firewall-cmd --permanent --add-port=22/tcp
      firewall-cmd --permanent --add-port=25/tcp
      firewall-cmd --permanent --add-port=8080/tcp
      firewall-cmd --permanent --add-port=2525/tcp
      firewall-cmd --reload
  else
      echo "Firewalld is installed but not running. Starting it..."
      systemctl start firewalld
      firewall-cmd --permanent --add-port=22/tcp
      firewall-cmd --permanent --add-port=25/tcp
      firewall-cmd --permanent --add-port=8080/tcp
      firewall-cmd --permanent --add-port=2525/tcp
      firewall-cmd --reload
  fi
else
  echo "Firewalld not found. Flushing iptables as fallback (warning: insecure)"
  iptables -F
fi

# ---------------- Inbound Stack Removed ----------------
# Inbound processing is handled by a central server (Split-Role Architecture).
# No local Dovecot, Roundcube, MariaDB, or Apache is installed here.

echo "PMTA installation and license setup completed successfully (Outbound Only Node)"

exit 0



